services:
  nis:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: nis-server
    ports:
      - "8080:8080"
    environment:
      - AUTH_JWT_SECRET=change-this-to-a-secure-random-secret-at-least-32-bytes-long
      - ENCRYPTION_KEY=12345678901234567890123456789012
      - DATABASE_AUTO_MIGRATE=true
      - DATABASE_DSN=/data/nis.db
    command: ["./nis", "serve", "--address", ":8080"]
    volumes:
      - nis_data:/data
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8080/healthz"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  nis-setup:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: nis-setup
    environment:
      - DATABASE_DSN=/data/nis.db
    command:
      - sh
      - -c
      - |
        echo "Waiting for NIS server..."
        sleep 10
        echo "Creating admin user..."
        ./nis user create admin --password admin123 --role admin || echo "Admin already exists"
    volumes:
      - nis_data:/data
    depends_on:
      nis:
        condition: service_healthy
    restart: "no"

  nats:
    image: nats:2.10-alpine
    container_name: nis-nats
    ports:
      - "4222:4222"
      - "8222:8222"
    command: ["-js", "-m", "8222"]
    volumes:
      - nats_data:/data
    restart: unless-stopped

volumes:
  nis_data:
  nats_data:
